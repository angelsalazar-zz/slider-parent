<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../slider-bar/slider-bar.html">
<link rel="import" href="../slider-zone/slider-zone.html">
<link rel="import" href="../slider-switch/slider-switch.html">
<link rel="import" href="../slider-endpoint/slider-endpoint.html">


<dom-module id="slider-parent">
  <template>
    <style>
        :host {
            display: flex;
            width: 100%;
            height: 25px;
        }
        :host > .slider-main{
            display: inline-block;
            height: 100%;
            width: calc(100% - 50px);
        }
        :host > ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
        :host > ul li  {
            border: 1px solid blue;
            margin-right: 4px;
            float: left;
        }
    </style>
        <slider-endpoint id="low" min></slider-endpoint>
        <div class="slider-main">
            <slider-zone id="upper">
            </slider-zone>
            <slider-bar></slider-bar>
            <slider-zone id="lower">
                <slider-switch id="lsh" on-tap="_handleTap" on-track="_handleTrack"  up></slider-switch>
            </slider-zone>
        </div>
        <slider-endpoint id="high"></slider-endpoint>
        <ul>
            <template is="dom-repeat" items="{{selected}}">
                <li>{{item.pos}}</li>
            </template>
        </ul>
        <array-selector id="selector" items="{{_objects}}" selected="{{selected}}" multi toggle></array-selector>
  </template>

  <script>
      Polymer({
          is: 'slider-parent',                          //Custom element name
          properties:{
              //Number of handles
              handles:{
                  type: Number,
                  value:1,       //default value
                  reflectToAttribute: true
              },
              //Min limit value
              min:{
                  type:Number,
                  value:0,
                  reflectToAttribute: true
              },
              //Max limit value
              max:{
                  type: Number,
                  value: 100,
                  reflectToAttribute: true
              },
              //_private array that stores the dynamic created slider-handles' values
              _objects:{
                  type: Array,
                  value: function(){
                      return [];
                  },
                  notify:true           //specifies that this property must be obversed
              }
          },
          //Observers array
          observers: [
              '_objectsPosChanged(_objects.*)'          //Fires when an item property is modified
          ],
          /*Ready function
           *Set the slider specify in the attribute handles
           */
          ready:function(){
              this.setHandles(this.handles);                                            //set initial handles
          },
          /*Public function
           *Append slider-handles to the slider-zone
           *@params numberOfHandles
           */
          setHandles: function(numberOfHandles){
              var i = numberOfHandles;                                                  //initialize number of loops
              //Check if there are loops left
              if(numberOfHandles != 0){
                  i--;                                                                  //decrease loops var
                  this._attachSliderHandle();                                           //append a slider Handle to the upper slider-zone
                  this.setHandles(i);  
              }else{
                  return;                                                               //finish recursion
              }
          },
          /*Private function
           *Create a slider-handle and append it to the slider-zone
           */
          _attachSliderHandle:function(){                                               
              var s_h = Polymer.Base.create('slider-switch');               //Create slider-handle component
              var generatedId = this._getNewId();                           //Generated new id based on slider-zone's children
              Polymer.dom(this.$.upper).appendChild(s_h);                   //Append slider-handle to the slider-zone
              this.set('id',generatedId,s_h);                               //Set id to the slider-handle                                    
              this.push('_objects',{pos:0});                                //push slider-handle position to the _objects array
              //this.listen(s_h, 'tap', '_deleteHandle');                   //add Tap event listener
              this.listen(s_h, 'tap', '_toggleSelection');                   //add Tap event listener
              Polymer.dom.flush();
          },
          //attach a slider-handle based on position
          _handleTap:function(e){
              var s_h = Polymer.Base.create('slider-switch');                           //create slider-handle component
              var generatedId = this._getNewId();                                       //Generated new id based on slider-zone's children
              this.set('pos',this._getCurrentPosition(e),s_h);                          //set Attribute (pos = currentPosition)
              this.push('_objects',{pos : this._mapBoundaries(e,s_h.pos) });            //push slider-handle position to the _objects array
              Polymer.dom(this.$.upper).appendChild(s_h);                               //Append slider-handle to the slider-zone
              this.set('id',generatedId,s_h);                                           //Set id to the slider-handle
              //this.listen(s_h, 'track', '_handleTrack');                                //add Tap event listener
              this.listen(s_h, 'tap', '_toggleSelection');                               //add Tap event listener
              Polymer.dom.flush()

          },
          // _handleTrack: function (e) {
          //     console.log(Polymer.dom(this.$.upper).querySelectorAll("slider-switch is-selected"));
          // },
          _handleTrack: function(e){
              this._moveSlider(e);
           },
          _moveSlider:function(e){
            //console.log(this.startDrag);
            var elementPos = $(e.currentTarget).offset(); // Current Target here is slider-parent
            if (e.detail.state==="start"){
              this.startDrag = e.detail.x - elementPos.left; // Store this position as the start point of track
            }
            var posX = e.detail.x - elementPos.left;
            // this.posX = posX;
            // this.elemLeft = elementPos.left;
            if(posX >= 0 && posX <= $(e.currentTarget).width()){
                $(e.currentTarget)[0].pos = posX;
                //$(e.currentTarget)[0].isTrackSource = true; // Flag this handle as the one on which tracking started
                this.set('_objects.'+$(e.currentTarget)[0].id+'.pos',this._mapBoundaries(e,posX));
            }
            /*if($(e.currentTarget)[0].isSelected){ // If it is a blue handle (selected), then it will also move other selected handles
              var elemList = (Polymer.dom(this.$.upper).childNodes); // Get child nodes
              for (var i=0;i<elemList.length;i++){ //iterate
                  if (elemList[i].isSelected){ // check to see if it is a selected handle
                    this.initialPos = elemList[i].pos;// store this position
                    var newPos = e.detail.x-this.initialPos-this.startDrag; // <--- SIMPLY NOT WORKING!!!
                    if(newPos >= 0 && newPos <= $(e.currentTarget).width()){
                      if(!elemList[i].isTrackSource){ // Make sure this is not e.currentTarget ! because we have moved it already
                          elemList[i].pos = newPos;
                      }
                    }
                  }
              }
              $(e.currentTarget)[0].isTrackSource = false; // Disable the flag for next cycle of track events
            }*/
           },
          //get the X current location when clicking the slider-handle located in the lower slider-zone
          _getCurrentPosition(e){
              var elementPos = $(e.currentTarget).parent().offset();    //Get slider-slider offSet
              return e.detail.x - elementPos.left;                      //Compute current position on the X axis
          },
          //detach the clicked slider-handle
          _deleteHandle: function(e){
              var deletedElement = Polymer.dom(this.$.upper).removeChild($(e.currentTarget)[0]);
              this.splice('_objects', deletedElement.id,1);
              this._updateIds(deletedElement.id);
              Polymer.dom.flush();
          },
          //Observer callback
          _objectsPosChanged: function(cr){
              if(cr.path.includes("pos")){
                  var nameSubpath = cr.path.indexOf('.pos');
                  var itempath = cr.path.substring(0, nameSubpath);
                  var item = this.get(itempath);
                  var index = cr.base.indexOf(item);
                  this._checkBoundaries(item.pos);
                  console.log('Item ' + index + ' changed, new position is: ' + item.pos);
                    
              }
          },
          //Update slider-handles ids based on index of the deleted one
          _updateIds:function(index){
              var i = index;
              if(i < this.$.upper.getEffectiveChildren().length){
                  this.set('id',i,this.$.upper.getEffectiveChildren()[i]);
                  i++;
                  this._updateIds(i);
              }else{
                  return;
              }
          },
          /*Map slider-hanlde value base on its position
           *@params {e: Event, positionX: slider-handle current x}
           */
          _mapBoundaries: function(e, positionX){
              var percent = Math.round((positionX*100)/$(e.currentTarget).parent().width())
              return Math.round((this.max - this.min)*percent/100)+this.min;
          },
          //Generated new id based on upper slider-zone effective children
          _getNewId:function(){
              //get upper slider-zone children
              return (this.$.upper.getEffectiveChildren().length);
          },
          _setHandles:function(){
              this.handles++;
          },
          _checkBoundaries: function(pos){
              if(pos == this.max){
                  if(!this.$.high.hardLimit){
                      this.max = this.max + 1;
                  }
              }
              if(pos == this.min){
                  if(!this.$.low.hardLimit){
                      this.min = this.min - 1;
                  }
              }
          },
          _toggleSelection: function(e) {
              //slider-switch should have index prop
              var item = this.get('_objects.#'+e.currentTarget.id);
              if(e.currentTarget.isSelected)
                  this.listen(e.currentTarget,'track','_handleTrack');
              else
                  this.unlisten(e.currentTarget,'track','_handleTrack')
              this.$.selector.select(item);
          }
          
          
    });
  </script>
</dom-module>
