<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../slider-bar/slider-bar.html">
<link rel="import" href="../slider-zone/slider-zone.html">
<link rel="import" href="../slider-switch/slider-switch.html">
<link rel="import" href="../slider-endpoint/slider-endpoint.html">

<dom-module id="slider-parent">
  <template>
    <style>
        :host {
            display: flex;
            width: 100%;
            height: 25px;
        }
        :host > .slider-main{
            display: inline-block;
            height: 25px;
            width: calc(100% - 50px);
        }
    </style>
        <slider-endpoint id="low" min></slider-endpoint>
        <div class="slider-main">
            <slider-zone id="upper" min-value="{{min}}" max-value="{{max}}">
                <template id="handles" is="dom-repeat" items="{{objects}}">
                    <slider-switch index="{{index}}"
                                  value="{{item.value}}"
                                  uid="{{item.uid}}"
                                  hover="{{item.hover}}"
                                  top-pos=-20
                                  is-selectable></slider-switch>
                </template>
            </slider-zone>
            <slider-bar></slider-bar>
            <slider-zone id="lower" min-value="{{min}}" max-value="{{max}}">
                  <slider-switch id="lsh" on-dblclick="_handleTap" value="0" top-pos=12 up is-selectable></slider-switch>
            </slider-zone>
        </div>
        <slider-endpoint id="high"></slider-endpoint>
  </template>

  <script>
      Polymer({
          is: 'slider-parent',
          properties:{
              handles:{
                  type: Number,
                  value:0,
                  reflectToAttribute: true,
                  notify:true
              },
              min:{
                  type:Number,
                  value:0,
                  reflectToAttribute: true,
                  notify:true
              },
              max:{
                  type: Number,
                  value: 100,
                  reflectToAttribute: true
              },
              objects:{
                  type: Array,
                  value: function(){
                      return [];
                  },
                  notify:true
              }
          },
          //Observers array
          observers: [
              'objectsPosChanged(objects.*)'          //Fires when an item property is modified
          ],
          //attach a slider-handle based on position
          _handleTap:function(e){
              //create slider-handle component Programatically
              /*var s_h = Polymer.Base.create('slider-switch');
              this.set('position',this._getCurrentPosition(e),s_h);
              this.set('isSelectable',true,s_h);
              this.set('topPos',-20,s_h);
              Polymer.dom(this.$.upper).appendChild(s_h);
              Polymer.dom.flush()*/
              this.push('objects',{value : this._getCurrentPosition(e)});
          },
          _getCurrentPosition(e){
              return e.currentTarget.value;                     //Compute current position on the X axis
          },
          //detach the clicked slider-handle
          /*_deleteHandle: function(e){
              var deletedElement = Polymer.dom(this.$.upper).removeChild($(e.currentTarget)[0]);
              this.splice('objects', deletedElement.id,1);
              this._updateIds(deletedElement.id);
              Polymer.dom.flush();
          },*/
          //Observer callback
          objectsPosChanged: function(cr){
              if(cr.path.includes("value")){
                  var nameSubpath = cr.path.indexOf('.value');
                  var itempath = cr.path.substring(0, nameSubpath);
                  var item = this.get(itempath);
                  var index = cr.base.indexOf(item);
                  var _modelContainer = this._searchModelByUid(item.uid);
                  var _modelViewer = this._getModelViewer()
                  // USE SET METHOD WHEN MUTATING OBJECTS OR ARRAYS,
                  // never use this approach _thumbNail.model.params.p1 = item.value;
                  //param: path (string)
                  //param: newValue (String,Number,Boolean)
                  // element.set(path,newValue);
                  _modelContainer.set('model.params.'+item.paramNumber,item.value);
                  if(item.uid == _modelViewer.model.uid)
                    _modelViewer.set('model.params.'+item.paramNumber,item.value);

                  //console.log(_modelContainer.model.params);
                  console.log('Item ' + index + ' changed, new position is: ' + item.value);
              }
              if(cr.path.includes("hover")){
                var nameSubpath = cr.path.indexOf('.hover');
                var itempath = cr.path.substring(0, nameSubpath);
                var item = this.get(itempath);
                var index = cr.base.indexOf(item);
                var _modelContainer = this._searchModelByUid(item.uid);
                if(item.hover){
                  _modelContainer.set('hover',true);
                }else {
                  _modelContainer.set('hover',false);
                }
                console.log('Item ' + item.uid + ' changed,  is hovered: ' + item.hover);
            }
          },
          /*Map slider-hanlde value base on its position
           *@params {e: Event, positionX: slider-handle current x}
           */
          _checkBoundaries: function(pos){
              if(pos == this.max){
                  if(!this.$.high.hardLimit){
                      this.max = this.max + 1;
                  }
              }
              if(pos == this.min){
                  if(!this.$.low.hardLimit){
                      this.min = this.min - 1;
                  }
              }
          },
          _searchModelByUid:function(uid){
            var _slidersWrapper = Polymer.dom(this).parentNode;
            var _paperHeaderPanelDrawer = Polymer.dom(_slidersWrapper).parentNode;
            var _paperDrawerPanel = Polymer.dom(_paperHeaderPanelDrawer).parentNode;
            return  _paperDrawerPanel.querySelector('model-container[id="'+uid+'"]');
          },
          _getModelViewer:function(){
            var _slidersWrapper = Polymer.dom(this).parentNode;
            var _paperHeaderPanelDrawer = Polymer.dom(_slidersWrapper).parentNode;
            var _paperDrawerPanel = Polymer.dom(_paperHeaderPanelDrawer).parentNode;
            return  _paperDrawerPanel.querySelector('model-viewer');
          }

    });
  </script>
</dom-module>
